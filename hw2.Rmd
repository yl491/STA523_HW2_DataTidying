Homework 2 - [Your team name here]
========================================================

### Task 0 - Load the data

```{r message = FALSE}
library(dplyr)
library(purrr)
library(tibble)
library(repurrrsive)
library(stringr)

load("lego_sales.RData")
```


### Task 1 - Tidying the data

<!-- Covert the `sales` object into a tidy data frame. Be sure to include a write up of your methods. -->

```{r}
list_cols = map(sales, ~ map_int(., length) )  %>% 
     map(~ which(. > 1)) %>% 
     unlist() %>% 
     names() %>% 
     unique()

d=map_df(
     sales, 
     function(row)
     {
         map_at(row, list_cols, list)
     }
 )

d$purchases <-NULL

num_purchases=rep(0,250)
for(i in 1:250)
{
  temp=unlist(sales[i])
  nam=temp[names(temp)=="purchases.Number"]
  num_purchases[i]=length(nam)
}

final = d %>%slice(rep(1:n(), num_purchases))

#### try using this instead of the for loop to generate num_purchases

test <- map(sales, "purchases") %>% map_int(length)
all(num_purchases == test) #shows equivalence between two vectors

#### J.C.


half2<-matrix(data=NA, nrow=sum(num_purchases),ncol=10)
iii=0
for (w in 1:250)
{
  temp=unlist(sales[w])
  for (ww in 1:num_purchases[w])
  {
    name1=temp[names(temp)=="purchases.SetID"][ww]
    name2=temp[names(temp)=="purchases.Number"][ww]
    name3=temp[names(temp)=="purchases.Theme"][ww]
    name4=temp[names(temp)=="purchases.Subtheme"][ww]
    name5=temp[names(temp)=="purchases.Year"][ww]
    name6=temp[names(temp)=="purchases.Name"][ww]
    name7=temp[names(temp)=="purchases.Pieces"][ww]
    name8=temp[names(temp)=="purchases.USPrice"][ww]
    name9=temp[names(temp)=="purchases.ImageURL"][ww]
    name10=temp[names(temp)=="purchases.Quantity"][ww]
    tempp=cbind(name1,name2,name3,name4,name5,name6,name7,name8,name9,name10)
    half2[iii+ww,]=tempp
  }
  iii=iii+num_purchases[w]
}
colnames(half2)=cbind("purchases.SetID","number","theme","subtheme","year","name","pieces","usprice","imageurl","quantity")

#### thoughts on using this code in lieu of the above

cols = map(sales,"purchases") %>% map(~map_int(.,length)) %>% unlist() %>% max()

half2_jc = matrix(data=NA, nrow=sum(num_purchases),ncol=cols)

iii = 0

for (i in 1:length(sales)){
  for (j in 1:num_purchases[i]){
    half2_jc[iii+j,] <- map(sales[i],"purchases")[[1]][[j]] %>% unlist()
  }
  iii = iii + num_purchases[i]
}
colnames(half2_jc) = map(sales[1],"purchases")[[1]][[1]] %>% names()

#test for equivalence of two methods

all(na.omit(half2_jc) == na.omit(half2))

######### J.C.

kkk=cbind(final,half2)
lego_sales=as_tibble(kkk) #thoughts on as_tibble() instead of as.data.frame ? - J.C.
  
```


<br/>

## Task 2 - Processing the data


1. What was the most common first name of purchasers? Last name?

```{r}
#first name
lego_sales %>% select(first_name:last_name)%>%
  unique()%>%
  group_by(first_name)%>%
  summarize(number = n())%>%
  filter(number == max(number))

#last name
lego_sales %>% select(first_name:last_name)%>%
  unique()%>%
  group_by(last_name)%>%
  summarize(number = n())%>%
  filter(number == max(number))

# J.C. - any thoughts on making these more efficient?
```

2. What are the five most popular lego sets based on these data?

```{r}
sort(table(lego_sales$purchases.SetID),decreasing = T)[1:5]
#Yunxuan

lego_sales%>%
  mutate(quantity = as.integer(quantity))%>%
  select(name,quantity)%>%
  group_by(name)%>%
  summarize(total = sum(quantity))%>%
  arrange(desc(total))%>%
  slice(1:5)

#J.C. - takes into account quantity of each unit purchased
```

3. Which five customers have spent the most money so far and how much have they spent?

```{r}
lego_sales %>% 
  mutate(quantity = as.integer(quantity), usprice = as.numeric(as.character(usprice)), receipts = quantity*usprice) %>% 
  select(first_name,last_name,receipts)%>%
  group_by(first_name,last_name) %>% 
  summarize(total_receipts = sum(receipts))%>%
  arrange(desc(total_receipts))%>%
  ungroup()%>%slice(1:5)

#J.C. - again, taking into account quantity of units purchased per transaction
```

4. Which lego theme has made the most money for lego?

```{r}
lego_sales %>% 
  mutate(quantity = as.integer(quantity), usprice = as.numeric(as.character(usprice)), receipts = quantity*usprice) %>% 
  select(theme,receipts)%>%
  group_by(theme)%>%
  summarize(total = sum(receipts))%>%
  filter(total == max(total))

#J.C.
```

5. Do men or women buy more lego sets (per person) on average?

```{r}
lego_sales %>% mutate(quantity = as.integer(quantity)) %>%
  select(gender:last_name,quantity)%>%
  group_by(gender) %>% 
  summarize( avg_sets = mean(quantity))%>%
  filter(avg_sets == max(avg_sets))

#J.C. - 'filter()' may not be needed, same with ":last_name" in 'select()'
```

6. What are the five most popular hobbies of lego purchasers?

```{r}
t = lego_sales %>% select(first_name,last_name,hobbies)%>%unique()

t2 = t %>% slice(rep(1:n(),map(hobbies,length)))


#any thoughts on how to proceed here? - J.C.
```

7. How many total pieces have been purchased from lego by these customers?

```{r}
total_pieces<-sum(na.omit(as.numeric(as.character(lego_sales$pieces))))

ttp<-as.character(lego_sales$pieces)%>%
  as.numeric()%>%
  na.omit()%>%
  sum()
#by yunxuan

lego_sales %>% 
  mutate(quantity = as.integer(quantity), pieces = as.numeric(as.character(pieces)), t_pieces = quantity*pieces) %>% 
  select(t_pieces) %>% 
  summarize(total = sum(na.omit(t_pieces)))

#J.C. - takes into account quantity purchased per transaction
```

8. Which area code has spent the most money on legos?

```{r}
lego_sales %>% select(phone_number, usprice, quantity) %>% 
  mutate(area_code = substr(phone_number,1,3), quantity = as.integer(quantity), usprice = as.numeric(as.character(usprice)), receipts = usprice*quantity) %>% 
  group_by(area_code) %>%
  summarize(total_area = sum(receipts)) %>% 
  filter(!is.na(area_code)) %>% 
  filter(total_area == max(total_area))

#J.C. - probably omit/alter the 'select()' at the beginning
```
