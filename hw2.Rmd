Homework 2 - [Team 09]
========================================================

### Task 0 - Load the data

```{r message = FALSE}
install.packages("repurrrsive")
library(dplyr)
library(purrr)
library(tibble)
library(repurrrsive)
library(stringr)

load("lego_sales.RData")
```


### Task 1 - Tidying the data

Write up: 
1. We first create a dataframe[D] that contains all customers' information (excluding purchases-related ones). \
2. For each customer, we extract out the length of purchases, and sum thoses lengths up to be the number of rows in the final dataset[NUM_PURCHASES]. We then create a matrix[FINAL] that replicates each row of [D] with #s of duplicated purchases.\
3. In dealing with duplicate purchases, we choose to put each purchase into a separate row. 
We create a matrix[HALF2] with [NUM_PURCHASES] as #s of row, the sum of purchases as #s of column. We loop through each customer's purchases to extract information and put those information into a row in M1.\
4. We combine [FINAL] and [HALF2], and get the clean dataset.\

```{r}
list_cols = map(sales, ~ map_int(., length) )  %>% 
     map(~ which(. > 1)) %>% 
     unlist() %>% 
     names() %>% 
     unique()
d=map_df(
     sales, 
     function(row)
     {
         map_at(row, list_cols, list)
     }
 )

d$purchases <-NULL
num_purchases <- map(sales, "purchases") %>% map_int(length)
final = d %>%slice(rep(1:n(), num_purchases))

cols = map(sales,"purchases") %>% map(~map_int(.,length)) %>% unlist() %>% max()
half2<-matrix(data=NA, nrow=sum(num_purchases),ncol=cols)

iii = 0

for (i in 1:length(sales)){
  for (j in 1:num_purchases[i]){
    half2[iii+j,] <- map(sales[i],"purchases")[[1]][[j]] %>% unlist()
  }
  iii = iii + num_purchases[i]
}
#write up here explaning duplicate purchases of same customer#########
colnames(half2) = map(sales[1],"purchases")[[1]][[1]] %>% names()

kkk=cbind(final,half2)
lego_sales=as_tibble(kkk) 

lego_sales$Quantity=as.integer(lego_sales$Quantity)
lego_sales$Pieces=as.numeric(as.character(lego_sales$Pieces))
lego_sales$USPrice=as.numeric(as.character(lego_sales$USPrice))
  
```


<br/>

## Task 2 - Processing the data


1. What was the most common first name of purchasers? Last name?

```{r}
#first name
lego_sales %>% select(first_name:last_name)%>%
  unique()%>%
  group_by(first_name)%>%
  summarize(number = n())%>%
  filter(number == max(number))

#last name
lego_sales %>% select(first_name:last_name)%>%
  unique()%>%
  group_by(last_name)%>%
  summarize(number = n())%>%
  filter(number == max(number))

```

2. What are the five most popular lego sets based on these data?

```{r}
lego_sales%>%
  
  select(Name,Quantity)%>%
  group_by(Name)%>%
  summarize(total = sum(Quantity))%>%
  arrange(desc(total)) %>%
  filter(total >= 9)

```

3. Which five customers have spent the most money so far and how much have they spent?

```{r}
lego_sales %>% 
  mutate(receipts = Quantity*USPrice, full_name = paste(first_name,last_name)) %>% 
  select(full_name,receipts)%>%
  group_by(full_name) %>% 
  summarize(total_receipts = sum(receipts))%>%
  arrange(desc(total_receipts))%>%
  slice(1:5)
```

4. Which lego theme has made the most money for lego?

```{r}
lego_sales %>% 
  mutate (receipts = Quantity*USPrice) %>% 
  select(Theme,receipts)%>%
  group_by(Theme)%>%
  summarize(total = sum(receipts))%>%
  filter(total == max(total))

```

5. Do men or women buy more lego sets (per person) on average?

```{r}
lego_sales %>%
  select(gender,Quantity)%>%
  group_by(gender) %>% 
  summarize(avg_sets = mean(Quantity))

```
\
Answer: Male.\
6. What are the five most popular hobbies of lego purchasers?

```{r}
t1 = lego_sales %>% select(hobbies) %>% unlist() %>% sort()
t2 = sapply(unique(t1), function(x){sum(t1 == x)}) %>% sort(.,decreasing = TRUE)
hobbies = t2[1:5]
hobbies

```

7. How many total pieces have been purchased from lego by these customers?

```{r}

lego_sales %>% 
  mutate(t_pieces = Quantity*Pieces) %>% 
  select(t_pieces) %>% 
  summarize(total = sum(na.omit(t_pieces)))

```

8. Which area code has spent the most money on legos?

```{r}
lego_sales %>% 
  mutate(area_code = substr(phone_number,1,3), receipts = USPrice*Quantity) %>% 
  select(area_code,receipts)%>%
  group_by(area_code) %>%
  summarize(total_area = sum(receipts)) %>% 
  filter(!is.na(area_code)) %>% 
  filter(total_area == max(total_area))

```
